version: '3.2'
services:

  # Container for Galaxy web (uwsgi webhandlers, job handlers, nginx, etc.)
  galaxy-stable:
    image: ${IMAGE_GALAXY_STABLE}
    container_name: galaxy-stable
    depends_on:
      - galaxy-postgres
    env_file: ./env/galaxy-stable
    hostname: galaxy-stable
    privileged: True
    ports:
      - "${GALAXY_PORT}:80" # nginx
    volumes:
        # This is the directory where all your files from Galaxy will be stored on your host system
      - type: volume
        source: galaxy-store-vol
        target: /export
      - type: volume
        source: docker-data-vol
        target: /data
      - type: volume
        source: docker-docker-vol
        target: /var/lib/docker
        read_only: true

  # PostgreSQL container
  galaxy-postgres:
    image: ${IMAGE_GALAXY_POSTGRES}
    container_name: galaxy-postgres
    hostname: galaxy-postgres
    volumes:
      - type: bind
        source: ${DIR_GALAXY_POSTGRES}
        target: /etc/supervisor
        read_only: true
      - type: volume
        source: galaxy-store-vol
        target: /export
      - type: volume
        source: docker-data-vol
        target: /data
      - type: volume
        source: docker-docker-vol
        target: /var/lib/docker
        read_only: true
    expose:
      - "5432"
    entrypoint: /etc/supervisor/config/startup.sh

  # PostgreSQL admin suite
  pgadmin4:
    image: ${IMAGE_PGADMIN4}
    container_name: pgadmin4
    ports:
        - "5050:5050"
    volumes:
        # This is the volume to persist pgadmin4 data
      - type: volume
        source: pgadmin4-vol
        target: /pgadmin
      - type: volume
        source: docker-data-vol
        target: /data
      - type: volume
        source: docker-docker-vol
        target: /var/lib/docker
        read_only: true
    restart: unless-stopped
    depends_on:
      - galaxy-postgres

  # proftpd container
  galaxy-proftpd:
    image: ${IMAGE_GALAXY_PROFTPD}
    container_name: galaxy-proftpd
    hostname: galaxy-proftpd
    volumes:
      - type: bind
        source: ${DIR_GALAXY_PROFTPD}
        target: /etc/supervisor
        read_only: true
      - type: volume
        source: galaxy-store-vol
        target: /export
      - type: volume
        source: docker-data-vol
        target: /data
      - type: volume
        source: docker-docker-vol
        target: /var/lib/docker
        read_only: true
    ports:
      - "8021:21" # ftp - only works in PASV mode at the moment, e.g., 'ftp -p localhost 8021'
      - "8022:22" # sftp
      # - "30000-30010:30000-30010" # ftp ports for non PASV mode - this is not working yet
    restart: always
    depends_on:
      - galaxy-postgres
    entrypoint: /etc/supervisor/config/startup.sh

volumes:
  # init galaxy-store-data container using the following commands
  #   # create the volume
  #   docker volume create galaxy-store-vol
  #   # optional, inspect resulting volume
  #   docker volume inspect galaxy-store-vol
  #   # create the data-storage container
  #   docker create --mount source=galaxy-store-vol,target=/export --name galaxy-store-data bgruening/galaxy-stable /bin/true
  #   # initialize the data-storage container
  #   docker run --rm -ti -p 8080:80 --volumes-from galaxy-store-data --name galaxy_bootstrap bgruening/galaxy-stable
  #   # Then use ^C to quit after export volume is initialized
  galaxy-store-vol:
    external: true
  # init pgadmin4-data container using the following commands
  #   # create the volume
  #   docker volume create pgadmin4-vol
  pgadmin4-vol:
    external: true
  # init volume to be mounted at /var/lib/docker
  docker-docker-vol:
    external: true
  # init volume to be mounted at /data
  docker-data-vol:
    external: true
